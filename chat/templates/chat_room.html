{% extends 'base.html' %}

{% block head %}
  <style>
    .message {
      display: flex;
      margin-bottom: 10px;
    }

    .message-content {
      padding: 10px;
      border-radius: 10px;
      background-color: #f0f0f0;
    }

    .self .message-content {
      align-self: flex-end;
      background-color: #e2f3ff;
    }

    .text-left, .text-right {
        margin-top: auto;
    }
    .text-left {
        margin-bottom: 20px;
    }

    #chatMessages {
      overflow-y: scroll;
      height: 75vh;
    }
  </style>
{% endblock %}

{% block content %}
  <h3>Chat Room: {{ room_name }} <a href="{% url 'home' %}" class="btn btn-secondary">Back to Home</a></h3>

  <meta name="csrf-token" content="{{ csrf_token }}">
  <div id="chatMessages" class="card mb-3">
    <div class="card-body">
      <div class="row" id="chatBox">
        <!-- Beginning of chat history -->
        <div class="col-2"></div>
        <div class="col-8 text-center">
          <a class="badge text-secondary-emphasis bg-secondary-subtle gray-900">This is the beginning of the chat history</a>
        </div>
        <div class="col-2"></div>

        {% for message in chat_messages %}
          <div class="col-4 d-{% if message.sender.username == current_user %}block{% else %}none{% endif %}"></div>
          <div class="col-8">
            <div class="message mb-3 {% if message.sender.username == current_user %}self float-end{% endif %}">
              <div class="message-content">
                <small style="font-size: 13px;">{{ message.sender.username }}</small>
                <p class="mb-1">{{ message.message }}</p>
                {% if message.url %}
                  <p class="mb-1">{{ message.url }}</p>
                {% endif %}
                {% if message.imageURL %}
                  <img src="{{ message.imageURL }}" alt="Uploaded Image" style="max-height:50px"><br>
                {% endif %}
                <small style="font-size: 11px;">{{ message.timestamp|date:"d-m-Y h:i:s A" }}</small>
              </div>
            </div>
          </div>
          <div class="col-4 d-{% if message.sender.username == current_user %}none{% else %}block{% endif %}"></div>
        {% endfor %}

      </div>
    </div>
    <div class="card-footer">
      <div class="input-group input-group-sm">
        <textarea class="form-control" id="messageInput" rows="2" placeholder="Type your message..."></textarea>
        <div class="input-group-append">
          <button type="button" id="sendButton" class="btn btn-primary">
            <i class="fa fa-paper-plane fa-fw"></i>
          </button>
          <input type="file" id="imageInput" accept="image/*" style="display: none;" />
          <button class="btn btn-warning text-white" type="button" onclick="document.getElementById('imageInput').click();">
            <i class="fa fa-upload"></i>
          </button>
          <button type="button" id="endButton" class="btn btn-danger">
            <i class="fa fa-file" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  {{ request.user.username|json_script:"user_username" }}
  {{ room_name|json_script:"room-name" }}

  <script>
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const userUsername = JSON.parse(document.getElementById('user_username').textContent);
    const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomName}/`);
    const chatBox = document.getElementById("chatBox");
    const chatMessages = document.getElementById("chatMessages");

    const dateFormat = (createdOn) => {
      const dateFormat = (createdOn) => createdOn ? new Date(createdOn).toLocaleString() : "Date not available";
      const d = new Date(createdOn);
      const day = d.getDate().toString().padStart(2, "0");
      const month = (d.getMonth() + 1).toString().padStart(2, "0");
      const year = d.getFullYear();
      const hours = d.getHours();
      const minutes = d.getMinutes().toString().padStart(2, "0");
      const amPm = hours >= 12 ? "PM" : "AM";
      const formattedHours = hours % 12 || 12;
      return `${day}-${month}-${year} ${formattedHours}:${minutes} ${amPm}`;
    };

    chatSocket.onmessage = function (e) {
      const message = JSON.parse(e.data);
      console.log("Received message:", message); // Debugging the data
      const isSelf = message.username === userUsername;

      const escapeHTML = (str) => str.replace(/</g, "&lt;").replace(/>/g, "&gt;");

      const messageContent = message.image_url
        ? `<img src="${escapeHTML(message.image_url)}" alt="Uploaded Image" class="img-fluid rounded" />`
        : `<p class="mb-1">${escapeHTML(message.message)}</p>`;

      const timestamp = dateFormat(message.timestamp);

      chatBox.innerHTML += `
        <div class="col-4 d-${isSelf ? 'block' : 'none'}"></div>
        <div class="col-8">
          <div class="message mb-3 ${isSelf ? 'self float-end' : ''}">
            <div class="message-content">
              <small style="font-size: 13px;">${escapeHTML(message.username)}</small>
              ${messageContent}
              <small style="font-size: 11px;">${timestamp}</small>
            </div>
          </div>
        </div>
        <div class="col-4 d-${isSelf ? 'none' : 'block'}"></div>
      `;

      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    document.getElementById('sendButton').addEventListener('click', () => {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();

      if (message) {
        chatSocket.send(JSON.stringify({ message: message }));
        messageInput.value = '';
      }
    });

    document.getElementById('imageInput').addEventListener('change', (event) => {
      const file = event.target.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          chatSocket.send(JSON.stringify({ image: e.target.result }));
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('endButton').addEventListener('click', () => {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      const chatMessagesData = Array.from(document.querySelectorAll('#chatBox .message')).map(messageElement => {
        return {
          username: messageElement.querySelector('small')?.textContent || 'Unknown',
          content: messageElement.querySelector('p')?.textContent || '',
          timestamp: new Date().toISOString()
        };
      });

      fetch(`/chat/generate_pdf/{{ chatroom.id }}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ messages: chatMessagesData, room_name: roomName })
      })
      .then(response => response.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_history_${roomName}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      })
      .catch(error => alert('Error generating PDF: ' + error.message));
    });
  </script>
{% endblock %}
